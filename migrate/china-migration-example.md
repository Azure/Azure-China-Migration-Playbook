---
title: 区域迁移示例
description: This article describes detailed steps to migrate resources of Contoso Company from Azure China East1 to China North2 region.
author: siguo
ms.service: china 
ms.topic: migrate
layout: ContentPage 
ms.date: 01/03/2020
ms.author: siguo

---

# 区域迁移示例

## 背景

Contoso 商业有限公司是一家提倡简约自然的家居品牌，在全球各地均有分公司，利用其遍布全球的线下门店和线上网络商城服务其全球用户。其线上商城系统是基于微软 Azure 服务开发，并就近部署在其全球主要消费者来源国家的 Azure 区域中。中国不但是其全球业务的主要来源，更是其未来重要的业务拓展区域，因此其面向中国消费者的已有线上商城系统采用了 Azure China 的服务，并部署在**东部1区域**中。

在过去一段时间中，公司收到的消费者对于线上商城系统问题的反馈不断增多，其中很多问题是已有系统架构的局限与业务快速发展的需求之间的冲突造成的。为了保证系统能够顺利支持公司不断增长的业务目标，公司委派架构师对系统进行重新评估，并抽调资源成立项目组配合其完成对系统的改造。

本示例借助 Contoso 公司的案例向大家描述了该公司**如何利用 Azure 跨区域业务迁移来解决系统架构局限与业务快速发展需求之间的冲突**，以及完整的迁移过程及各阶段的注意事项。

### 问题描述

公司现有线上商城系统的 IT 架构是根据5年前的业务需求，预测及 Azure China 云服务路线图设计的，系统已经上线运行了4年多。按照一般 IT 系统平均生命周期5年计算，需要尽快对线上商城进行升级改造，才能满足系统业务需求。架构师对现有系统架构进行了分析、并对系统运维团队及消费者反馈问题也进行了整理、分类和深入分析，分析结果充分验证了这一点。
分析结果可以归结为几个核心问题，即系统升级改造的核心需求如下：

* **系统弹性需求**：由于过去几年消费者从线下到线上的不断迁移，以及“双11”，“6.18”等线上购物节影响力的不断扩大，造成系统需要承载的业务量在某些特定时段内会有几倍、甚至几十倍的增长，对系统的弹性要求带来了巨大的挑战。
* **业务增长需求**：随着公司在中国业务的快速增长，以及消费者向线上的不断迁移，公司预计未来三年其在中国的线上商城业务规模将会有两倍以上的增长，需要制定中长期的系统扩容计划以满足发展需要。
* **功能迭代需求**：随着中国业务的不断扩张及中国零售行业的产业升级，公司的营销策略也从简单、粗暴的优惠促销获客方式转换为以数据分析为基础的精准运营模式。例如：通过分析站点流量来源、浏览到购买的转化过程，并根据客户当前行为及其历史画像数据：
    * 定制推荐产品、特别优惠，提高转化率；
    * 个性化的展示方式，及个性化的交互体验，增加满意度，实现真正意义上的“千人千面”；
* **成本优化需求**：随着业务规模的快速增长，系统基础资源资源采购成本，及系统运维成本也随之线性增长。如何通过优化系统架构，降低成本来提高利润空间，变成了摆在技术部门面前需要尽快解决的问题。

## 准备

首先，在对系统进行升级改造之前，架构师从各相关部门抽调资深人员对已有系统问题进行分析，制定解决方案，并系统评估方案的可行性及风险，并针对性的制定计划及风险预案。

### 解决方案

在问题的分析过程中，架构师与产品团队，运维团队，运营团队及部分消费者都进行了积极的沟通和讨论，发现除了已有系统采用的技术框架已经不能满足当前业务需求外，Azure China 各区域的服务上线策略、区域扩容计划、区域价格策略等都会对未来业务系统能否以合理成本稳定运维产生影响。
因此，架构师通过微软客户经理与微软的技术支持团队进行了积极的沟通，全面的了解了微软 Azure 服务的发布及推广策略，总结为以下几点结论和策略，作为后续的系统升级的指导原则：

* **区域资源饱和风险低**：对于任何云服务，每个区域的数据中心资源都会随着预留资源的不断被使用而渐渐饱和。一旦进入饱和，需要对区域进行扩容以提供新的容量，但是扩容的周期一般比较长，会有阶段性资源紧缺的风险。Contoso 当前线上商城系统所部署的**东部1区域**已经开放了5年，阶段性资源饱和的风险比较高，而刚刚上线不久的**北部2区域**及**东部2区域**，由于刚开放不到2年，资源饱和的风险较小，是未来几年最合适的备选区域。
* **所需服务发布及时**：各区域提供的服务及更新的速度是有所区别的，与该区域的可用资源及用户需求息息相关。如 AKS 服务、时序见解、自动化等功能，在**东部1区域**暂时都没有支持，这些服务的缺失，严重的限制了系统功能的开发速度，也提高了系统的复杂度，及系统运维成本。例如：更高级的虚拟机和云服务，Azure Kubernetes 服务，Azure SQL Database托管实例，Azure时序见解，自动化等电商平台个性化解决方案所需服务。同时更多新服务未来也会在**北部2区域**及**东部2区域**及时发布。
* **所用资源性价比高**：各区域资源的市场价格策略会受到该区域资源使用率的影响，区域可用资源越多，可以预见该区域未来通过价格杠杆来促进资源销售的概率越高，即促销的可能越大。基于与微软相关团队的探讨，**北部2区域**是目前已开放区域中可用资源最多的，未来进行价格促销的概率最高。目前，**北部2区域**的 CPP 价格比**东部1区域**便宜约20%-30%左右。

综合以上，结构师得出初步的解决方案结论，即**在升级改造过程中将系统从 东部1区域 迁移到 北部2区域 中**。

### 团队搭建

系统升级改造（迁移）不是由技术团队独立完成的，需要从各关键部门指定接口人，成立 V-Team 以相互配合共同完成。在本示例中，Contoso 成立了两个 V-Team，团队成员包括：公司管理团队成员，产品团队、运维团队、业务运营团队、财务团队等。

1. 决策 V-Team：各团队的决策者；
   * 分析迁移后的业务影响
   * 确定迁移的最佳方案
   * 找到受影响的业务系统，指定相关接口人，共同合作完善迁移方案
   * 跟踪整个执行过程，确保执行成功。
2. 执行 V-Team：各团队的资深成员，执行者；
   * 详细分析迁移后的业务影响
   * 迁移过程中需增加或升级的功能
   * 迁移后的割接方案
   * 建议的时间节点
   * 明确实施迁移的实施和审批流程
   * 通过流程确保所有相关团队了解迁移计划、影响，并达成共识
   * 提供相关培训，确保相关团队在迁移后系统的业务运维及运营的顺利开展

### 可行评估

架构师基于关于解决方案的初步结论，需要进一步从技术、财务、业务风险等多个方面进行系统的评估，以确定方案的可行性及带来的成本、业务方面的影响。

#### 当前使用资源:   

当前线上商城所使用资源都部署在 Azure China **东部1区域**的数据中心中，在过去4年多的使用过程中没有进行过大的系统架构改造。其所使用的资源比较简单，目前只包含：计算、存储、网络。   
* 计算：
  * 虚拟机(D2/D3/D4/D5/F4/F)： x15
  * 合计用量： 40K Hour/Month
* 存储： 
   * 磁盘(P30/P10/P15/P6/S30/S15)： x11 
   * GRS存储/LRS Snapshots： x40 
* 网络：
  * Basic Gateway： x1
  * Standard Static Public IP： x1
  * Dynamic Public IP： x1

**在此阶段结束时，您将拥有：**
  *	需要迁移的 Azure 资源的完整列表。
  
#### 技术评估 

在技术评估阶段，您需要召集**执行 V-Team** 从以下不同角度完成评估：

* 迁移策略：  
  根据技术及业务现状，讨论迁移策略。在本示例中，Contoso 希望在迁移过程中实现以下目标：  
    * 利用此次迁移机会重新设计技术架构，并利用更多 PaaS 层级的云服务
      * 使用 AKS 和 SQL 托管实例功能来优化数据存储性能；
      * 使用 AKS 服务/时序见解/自动化等功能分析站点流量和浏览到购买的转化率，以根据客户行为确定特别优惠和新产品，并创造具有目标内容和优惠的个性化购物体验，增加满意度；
      * 使用 Security Center 和 Azure Policy 来提高开发部署的安全性。
    * 目前使用的某些 D 系列虚拟机型号较老，各方面指标不够强大，无法满足未来的工作负载。技术团队预计要将 D 系列虚拟机全部更换成 DSv2 系列，可为企业提供更快的 CPU、更好的本地磁盘性能和更高内存。 

  具体到迁移策略，可以有两个不同选择：**迁移、然后改造** 和 **迁移 + 改造**。
    * **迁移、然后改造**：将位于**东部1区域**的资源直接迁移到**北部2区域**，然后对系统进行升级改造。这种做法可以分阶段进行，通过小步走的渐进、局部改造方式完成系统升级。
    * **迁移 + 改造**：在**北部2区域**中部署升级改造过的系统模块，然后将没有变化的模块从**东部1区域**直接迁移到**北部2区域**，最后进行数据迁移及转换完成整个过程。这种做法迁移周期短，节省成本。 
* 资源评估：  
  在每个订阅运行一系列脚生成资源组、每个资源组中的资源以及环境中的资源组部署设置的列表。将生成的列表与开发团队进行确认，确保生成的资源列表与已有系统的部署方案中涉及资源保持一致。 
* 环境评估：   
  了解源区域的环境和目的区域的环境之间服务与配置的一致性，估算在目的环境中的资源成本和运维成本。   
* 依赖关系评估：   
  梳理部署在 Azure 中各应用程序之间以及与外部系统的依赖关系，接口及接口版本信息。
* 复杂性评估：   
  评估系统在 Azure 中的部署架构，部署的各类资源之间的依赖关系，了解系统迁移的复杂度。 
* 性能分析：   
  梳理系统各模块的性能指标，并在目标环境中进行相应性能测试，以确保目标环境中的各类资源能满足性能要求。  
* 初步测试：   
  根据系统内部及外部依赖关系，制订迁移评估方案。通过执行有限范围的测试来验证迁移方案。  

**在此阶段结束时，您将拥有：**
  *	系统内部资源之间的依赖关系，及外部系统依赖关系列表。
  *	包含迁移方案，迁移周期等信息的迁移复杂度评估信息。
  * 完成供决策 V-Team 进行审批的综合技术评估报告。

#### 财务评估

估算整个迁移过程中涉及的成本支出，确保具有相应的审批和预算来完成迁移。

* **日常运维成本：** 估算在目标环境中的日常运维成本及使用成本。  
  * 根据目标环境中预计使用的资源列表，估算使用成本。大部分存储和计算资源的使用成本在**北部2区域**将会降低约10%~30%。
  * 根据已有系统的运维方案估算目标环境中的运维成本。使用高级的托管资源将预计节省10%人力成本。
* **迁移成本：** 估算整个迁移过程中必需的人员/工具/额外资源及合作伙伴等的成本。  
  * 估算为迁移项目支付的人力成本。
  * 估算为迁移项目支付的第三方工具成本（包含：迁移工具、新环境带来的第三方系统使用成本等）。
  * 估算为迁移项目支付的额外 Azure 资源使用成本。
  * 估算为迁移项目支付的合作伙伴成本。

**在此阶段结束时，您将拥有：**
  * 完成供决策 V-Team 进行审批的综合财务评估报告。

#### 风险评估

系统的迁移有可能会造成业务中断风险，需要进行相应的风险评估，并根据风险评估结果制订迁移计划。

* 业务风险
  *	业务运营影响: 整个迁移过程可能会持续几个月，其间有可能会对系统的稳定运行及性能带来影响。需要评估迁移项目的合理开展时间，如何规避旺季及关键商业活动的时间窗口。  
  *	业务中断风险：评估业务割接导致的业务中断对公司业务带来的影响，评估合适的业务割接窗口，以减少业务中断带来的业务影响。
* 降低风险方案	
  * 根据割接窗口评估业务影响范围，评估可行的应急预案（包含：响应机制、回滚方案等）。
  * 评估应急预案需要的预算和人员。 
  * 建议与您的微软AE联系，基于您的需求，共同讨论分析潜在风险，及可行的建议，降低迁移的风险迁移。

**在此阶段结束时，您将拥有：**
  * 完成供决策 V-Team 进行审批的综合风险评估报告。

#### （可选）方案审批
决策 V-Team 与公司决策层基于评估进行审批，执行 V-Team 基于审批结果开展迁移工作。

## 迁移过程
在经过以上的评估之后，管理层决定 Contoso 中国分公司确定开启其 Azure China 迁移项目，你可以开始协调各个部门及 V-Team 开始以下三个阶段的工作。

### 计划阶段

#### 关键任务
在计划阶段，您应当完成以下任务：
*	使用在评估阶段完成的依赖关系分析的输出结果来定义相关组件。请考虑通过迁移包迁移相关组件并为每个迁移包创建用户验收测试计划。 
* （可选）利用迁移过程来应用 Gartner 5-R 标准和优化工作负载。  
*	确定目标 Azure 区域中的目标环境和要求。
*	识别目标 Azure 租户（如有必要，创建一个）并创建订阅。 
*  确定新区域中的网络规划，例如：新的网段/ VNet/ ER 专线等。
*  确定是否需要新的域名及备案。
*  确定迁移后的资源是否需要采购新的 Liscence 。
*	设计详细的迁移计划报告。 
*	确定合适的迁移时间线和计划表。 
*	在你评估环境时，将为你提供一个包含成本分析步骤的完美机会。 使用评估活动收集的数据，你应该能够分析和预测成本。 除了任何一次性成本之外，此成本预测还应考虑消耗量服务成本（例如增加的数据入口）。

#### 关键产出
在此阶段结束时，您将拥有： 
* 迁移计划报告：部署体系结构的具体设计文档。
* 成本分析报告：包括迁移成本和目标环境的资源消耗等。  
*	新的CPP合同：根据预测 Contoso 在中国北部2区域的资源用量，重新签订CPP合同。这需要对 Azure 做出前期货币承诺，同时可让 Contoso 获得众多权益，包括灵活的计费选项和最优惠价格。
*  新的 Lisence、网络及域名：根据 Contoso 公司的实际情况，重新准备相应的资源。
*	时间线和计划表：根据迁移计划表，为迁移项目建立大致时间线和里程碑。

### 迁移阶段

#### 商务准备
* 与商务和财务人员讨论重新签署 CPP 合同，并根据 CPP 合同中承诺的资源进行架构调整。
#### 关键任务
1.	在 Azure 中国北部区域2 中创建新的资源组 CONTOSORG2。
2.	[在目标区域中创建新的虚拟网络。](https://docs.azure.cn/zh-cn/articles/azure-china-migration-playbook/china-migration-guidance-networking)
3.	在新区域中创建和配置 VPN 网关的新实例。需要注意的是有一些 PaaS 服务不支持 Vnet Peering，需要手动配对。
4.	[使用ASR迁移虚拟机到中国北部2 的资源组。](https://docs.azure.cn/zh-cn/site-recovery/azure-to-azure-tutorial-migrate)
5.	[迁移存储资源。](https://docs.azure.cn/zh-cn/articles/azure-china-migration-playbook/china-migration-guidance-storage)
6.	配置 CONTOSORG2 新建的资源。
7.	为迁移后的资源[配置灾难恢复和备份。](https://docs.azure.cn/zh-cn/site-recovery/azure-to-azure-quickstart)
#### 关键产出
* 在新的区域部署的资源及配置的完整列表。 
*	新区域资源的灾难恢复和备份。

### 验收阶段
#### 关键任务
当资源迁移已经完成，则进入验证阶段，完成以下任务：
*	完成用户验收测试。 
*	检验迁移过程中是否产生新增数据。如果有，将最新数据同步到目标环境。 
*	确保应用程序按预期工作。 
*	切换到目标区域中的新应用程序实例。 
*	验证生产环境是否按预期工作。 
*	取消配置源区域中的资源。
*	基础设施测试。  
*  早期生命支持。
*	与终端客户进行质量检查与割接合作。

#### 关键产出
*	迅速过度 
*	决定上线
*	交接  
*	月度/周度的运营报告




